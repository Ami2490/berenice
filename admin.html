<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administrador - Berenice Importaciones</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        .berenice-gold { color: #D4AF37; }
        .berenice-bg-gold { background-color: #D4AF37; }
        .sidebar-active { background-color: #D4AF37; color: #000; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="w-64 bg-white shadow-lg">
            <div class="p-6 border-b">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 berenice-bg-gold rounded-lg flex items-center justify-center">
                        <i data-lucide="store" class="w-6 h-6 text-black"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-gray-900">Berenice</h1>
                        <p class="text-sm text-gray-500">Administrador</p>
                    </div>
                </div>
            </div>
            
            <nav class="mt-6">
                <div class="px-6 py-2">
                    <button onclick="showSection('dashboard')" class="sidebar-btn w-full flex items-center space-x-3 px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors">
                        <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                        <span>Dashboard</span>
                    </button>
                </div>
                <div class="px-6 py-2">
                    <button onclick="showSection('products')" class="sidebar-btn w-full flex items-center space-x-3 px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors">
                        <i data-lucide="package" class="w-5 h-5"></i>
                        <span>Productos</span>
                    </button>
                </div>
                <div class="px-6 py-2">
                    <button onclick="showSection('orders')" class="sidebar-btn w-full flex items-center space-x-3 px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors">
                        <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                        <span>Pedidos</span>
                    </button>
                </div>
                <div class="px-6 py-2">
                    <button onclick="showSection('customers')" class="sidebar-btn w-full flex items-center space-x-3 px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors">
                        <i data-lucide="users" class="w-5 h-5"></i>
                        <span>Clientes</span>
                    </button>
                </div>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="flex-1 overflow-hidden">
            <!-- Header -->
            <header class="bg-white shadow-sm border-b px-6 py-4">
                <div class="flex items-center justify-between">
                    <h2 id="page-title" class="text-2xl font-bold text-gray-900">Dashboard</h2>
                    <div class="flex items-center space-x-4">
                        <button class="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100">
                            <i data-lucide="bell" class="w-5 h-5"></i>
                        </button>
                        <div class="w-8 h-8 bg-gray-300 rounded-full"></div>
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <main class="flex-1 overflow-y-auto p-6">
                <!-- Dashboard Section -->
                <div id="dashboard-section" class="section">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">Total Productos</p>
                                    <p id="total-products" class="text-2xl font-bold text-gray-900">0</p>
                                </div>
                                <div class="w-12 h-12 berenice-bg-gold rounded-lg flex items-center justify-center">
                                    <i data-lucide="package" class="w-6 h-6 text-black"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">Total Pedidos</p>
                                    <p id="total-orders" class="text-2xl font-bold text-gray-900">0</p>
                                </div>
                                <div class="w-12 h-12 bg-blue-500 rounded-lg flex items-center justify-center">
                                    <i data-lucide="shopping-cart" class="w-6 h-6 text-white"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">Total Clientes</p>
                                    <p id="total-customers" class="text-2xl font-bold text-gray-900">0</p>
                                </div>
                                <div class="w-12 h-12 bg-green-500 rounded-lg flex items-center justify-center">
                                    <i data-lucide="users" class="w-6 h-6 text-white"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">Ventas Totales</p>
                                    <p id="total-sales" class="text-2xl font-bold berenice-gold">$UYU 0</p>
                                </div>
                                <div class="w-12 h-12 bg-purple-500 rounded-lg flex items-center justify-center">
                                    <i data-lucide="dollar-sign" class="w-6 h-6 text-white"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Productos Más Vendidos</h3>
                            <div id="top-products" class="space-y-3">
                                <!-- Se llenará dinámicamente -->
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Pedidos Recientes</h3>
                            <div id="recent-orders" class="space-y-3">
                                <!-- Se llenará dinámicamente -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Products Section -->
                <div id="products-section" class="section hidden">
                    <div class="bg-white rounded-lg shadow">
                        <div class="p-6 border-b">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg font-semibold text-gray-900">Gestión de Productos</h3>
                                <button onclick="showProductModal()" class="berenice-bg-gold text-black px-4 py-2 rounded-lg hover:bg-yellow-600 transition-colors">
                                    <i data-lucide="plus" class="w-4 h-4 inline mr-2"></i>
                                    Nuevo Producto
                                </button>
                            </div>
                        </div>
                        
                        <div class="p-6">
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead>
                                        <tr class="border-b">
                                            <th class="text-left py-3 px-4">Producto</th>
                                            <th class="text-left py-3 px-4">Categoría</th>
                                            <th class="text-left py-3 px-4">Precio</th>
                                            <th class="text-left py-3 px-4">Stock</th>
                                            <th class="text-left py-3 px-4">Estado</th>
                                            <th class="text-left py-3 px-4">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="products-table">
                                        <!-- Se llenará dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Orders Section -->
                <div id="orders-section" class="section hidden">
                    <div class="bg-white rounded-lg shadow">
                        <div class="p-6 border-b">
                            <h3 class="text-lg font-semibold text-gray-900">Gestión de Pedidos</h3>
                        </div>
                        
                        <div class="p-6">
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead>
                                        <tr class="border-b">
                                            <th class="text-left py-3 px-4">ID</th>
                                            <th class="text-left py-3 px-4">Cliente</th>
                                            <th class="text-left py-3 px-4">Total</th>
                                            <th class="text-left py-3 px-4">Estado</th>
                                            <th class="text-left py-3 px-4">Fecha</th>
                                            <th class="text-left py-3 px-4">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="orders-table">
                                        <!-- Se llenará dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Customers Section -->
                <div id="customers-section" class="section hidden">
                    <div class="bg-white rounded-lg shadow">
                        <div class="p-6 border-b">
                            <h3 class="text-lg font-semibold text-gray-900">Gestión de Clientes</h3>
                        </div>
                        
                        <div class="p-6">
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead>
                                        <tr class="border-b">
                                            <th class="text-left py-3 px-4">Nombre</th>
                                            <th class="text-left py-3 px-4">Teléfono</th>
                                            <th class="text-left py-3 px-4">Email</th>
                                            <th class="text-left py-3 px-4">Pedidos</th>
                                            <th class="text-left py-3 px-4">Total Gastado</th>
                                            <th class="text-left py-3 px-4">Último Pedido</th>
                                        </tr>
                                    </thead>
                                    <tbody id="customers-table">
                                        <!-- Se llenará dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Product Modal -->
    <div id="product-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
                <div class="p-6 border-b">
                    <div class="flex items-center justify-between">
                        <h3 id="modal-title" class="text-lg font-semibold text-gray-900">Nuevo Producto</h3>
                        <button onclick="hideProductModal()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
                
                <form id="product-form" class="p-6 space-y-4">
                    <input type="hidden" id="product-id">
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
                        <input type="text" id="product-name" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
                        <textarea id="product-description" rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500"></textarea>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Precio (UYU)</label>
                            <input type="number" id="product-price" step="0.01" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Stock</label>
                            <input type="number" id="product-stock" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500" required>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Categoría</label>
                        <select id="product-category" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500" required>
                            <option value="">Seleccionar categoría</option>
                            <option value="mujeres">Mujeres</option>
                            <option value="hombres">Hombres</option>
                            <option value="ninos">Niños</option>
                            <option value="pijamas">Pijamas</option>
                            <option value="casual">Casual</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tallas (separadas por coma)</label>
                        <input type="text" id="product-sizes" placeholder="S, M, L, XL" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">URL de Imagen</label>
                        <input type="url" id="product-image" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500">
                    </div>
                    
                    <div class="flex items-center">
                        <input type="checkbox" id="product-featured" class="mr-2">
                        <label for="product-featured" class="text-sm text-gray-700">Producto destacado</label>
                    </div>
                    
                    <div class="flex space-x-3 pt-4">
                        <button type="submit" class="flex-1 berenice-bg-gold text-black py-2 px-4 rounded-lg hover:bg-yellow-600 transition-colors">
                            Guardar
                        </button>
                        <button type="button" onclick="hideProductModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Global variables
        let products = [];
        let orders = [];
        let customers = [];

        // API functions
        async function fetchData(endpoint) {
            try {
                const response = await fetch(`/api${endpoint}`);
                return await response.json();
            } catch (error) {
                console.error('Error fetching data:', error);
                return [];
            }
        }

        async function saveProduct(productData) {
            try {
                const method = productData.id ? 'PUT' : 'POST';
                const url = productData.id ? `/api/products/${productData.id}` : '/api/products';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(productData)
                });
                
                return await response.json();
            } catch (error) {
                console.error('Error saving product:', error);
                throw error;
            }
        }

        async function deleteProduct(productId) {
            try {
                const response = await fetch(`/api/products/${productId}`, {
                    method: 'DELETE'
                });
                return await response.json();
            } catch (error) {
                console.error('Error deleting product:', error);
                throw error;
            }
        }

        // UI functions
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Remove active class from all sidebar buttons
            document.querySelectorAll('.sidebar-btn').forEach(btn => {
                btn.classList.remove('sidebar-active');
            });
            
            // Show selected section
            document.getElementById(`${sectionName}-section`).classList.remove('hidden');
            
            // Add active class to clicked button
            event.target.closest('.sidebar-btn').classList.add('sidebar-active');
            
            // Update page title
            const titles = {
                dashboard: 'Dashboard',
                products: 'Productos',
                orders: 'Pedidos',
                customers: 'Clientes'
            };
            document.getElementById('page-title').textContent = titles[sectionName];
            
            // Load section data
            switch(sectionName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'products':
                    loadProducts();
                    break;
                case 'orders':
                    loadOrders();
                    break;
                case 'customers':
                    loadCustomers();
                    break;
            }
        }

        function showProductModal(product = null) {
            const modal = document.getElementById('product-modal');
            const form = document.getElementById('product-form');
            const title = document.getElementById('modal-title');
            
            if (product) {
                title.textContent = 'Editar Producto';
                document.getElementById('product-id').value = product.id;
                document.getElementById('product-name').value = product.name;
                document.getElementById('product-description').value = product.description || '';
                document.getElementById('product-price').value = product.price;
                document.getElementById('product-stock').value = product.stockQuantity;
                document.getElementById('product-category').value = product.category;
                document.getElementById('product-sizes').value = product.sizes.join(', ');
                document.getElementById('product-image').value = product.image || '';
                document.getElementById('product-featured').checked = product.featured;
            } else {
                title.textContent = 'Nuevo Producto';
                form.reset();
                document.getElementById('product-id').value = '';
            }
            
            modal.classList.remove('hidden');
        }

        function hideProductModal() {
            document.getElementById('product-modal').classList.add('hidden');
        }

        // Data loading functions
        async function loadDashboard() {
            try {
                const stats = await fetchData('/stats/dashboard');
                
                document.getElementById('total-products').textContent = stats.totalProducts || 0;
                document.getElementById('total-orders').textContent = stats.totalOrders || 0;
                document.getElementById('total-customers').textContent = stats.totalCustomers || 0;
                document.getElementById('total-sales').textContent = `$UYU ${(stats.totalSales || 0).toLocaleString()}`;
                
                // Load top products
                const topProductsContainer = document.getElementById('top-products');
                topProductsContainer.innerHTML = '';
                
                if (stats.topProducts && stats.topProducts.length > 0) {
                    stats.topProducts.forEach(product => {
                        const div = document.createElement('div');
                        div.className = 'flex items-center justify-between py-2';
                        div.innerHTML = `
                            <span class="text-sm text-gray-900">${product.name}</span>
                            <span class="text-sm text-gray-500">${product.totalSold} vendidos</span>
                        `;
                        topProductsContainer.appendChild(div);
                    });
                } else {
                    topProductsContainer.innerHTML = '<p class="text-gray-500 text-sm">No hay datos disponibles</p>';
                }
                
                // Load recent orders
                const recentOrdersContainer = document.getElementById('recent-orders');
                recentOrdersContainer.innerHTML = '<p class="text-gray-500 text-sm">No hay pedidos recientes</p>';
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        async function loadProducts() {
            try {
                products = await fetchData('/products');
                const tbody = document.getElementById('products-table');
                tbody.innerHTML = '';
                
                products.forEach(product => {
                    const tr = document.createElement('tr');
                    tr.className = 'border-b hover:bg-gray-50';
                    tr.innerHTML = `
                        <td class="py-3 px-4">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-gray-200 rounded-lg"></div>
                                <div>
                                    <p class="font-medium text-gray-900">${product.name}</p>
                                    <p class="text-sm text-gray-500">${product.category}</p>
                                </div>
                            </div>
                        </td>
                        <td class="py-3 px-4 text-gray-900">${product.category}</td>
                        <td class="py-3 px-4 text-gray-900">$UYU ${product.price.toLocaleString()}</td>
                        <td class="py-3 px-4 text-gray-900">${product.stockQuantity}</td>
                        <td class="py-3 px-4">
                            <span class="px-2 py-1 text-xs rounded-full ${product.inStock ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${product.inStock ? 'En Stock' : 'Agotado'}
                            </span>
                        </td>
                        <td class="py-3 px-4">
                            <div class="flex space-x-2">
                                <button onclick="showProductModal(${JSON.stringify(product).replace(/"/g, '&quot;')})" class="text-blue-600 hover:text-blue-800">
                                    <i data-lucide="edit" class="w-4 h-4"></i>
                                </button>
                                <button onclick="confirmDeleteProduct(${product.id})" class="text-red-600 hover:text-red-800">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                
                // Re-initialize Lucide icons
                lucide.createIcons();
                
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

        async function loadOrders() {
            try {
                orders = await fetchData('/orders');
                const tbody = document.getElementById('orders-table');
                tbody.innerHTML = '';
                
                if (orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="py-8 text-center text-gray-500">No hay pedidos registrados</td></tr>';
                    return;
                }
                
                orders.forEach(order => {
                    const tr = document.createElement('tr');
                    tr.className = 'border-b hover:bg-gray-50';
                    tr.innerHTML = `
                        <td class="py-3 px-4 font-medium text-gray-900">#${order.id}</td>
                        <td class="py-3 px-4 text-gray-900">${order.customerName}</td>
                        <td class="py-3 px-4 text-gray-900">$UYU ${order.totalAmount.toLocaleString()}</td>
                        <td class="py-3 px-4">
                            <span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800">
                                ${order.status}
                            </span>
                        </td>
                        <td class="py-3 px-4 text-gray-900">${new Date(order.createdAt).toLocaleDateString()}</td>
                        <td class="py-3 px-4">
                            <button class="text-blue-600 hover:text-blue-800">
                                <i data-lucide="eye" class="w-4 h-4"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                
                // Re-initialize Lucide icons
                lucide.createIcons();
                
            } catch (error) {
                console.error('Error loading orders:', error);
            }
        }

        async function loadCustomers() {
            try {
                customers = await fetchData('/customers');
                const tbody = document.getElementById('customers-table');
                tbody.innerHTML = '';
                
                if (customers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="py-8 text-center text-gray-500">No hay clientes registrados</td></tr>';
                    return;
                }
                
                customers.forEach(customer => {
                    const tr = document.createElement('tr');
                    tr.className = 'border-b hover:bg-gray-50';
                    tr.innerHTML = `
                        <td class="py-3 px-4 font-medium text-gray-900">${customer.name}</td>
                        <td class="py-3 px-4 text-gray-900">${customer.phone}</td>
                        <td class="py-3 px-4 text-gray-900">${customer.email || '-'}</td>
                        <td class="py-3 px-4 text-gray-900">${customer.totalOrders}</td>
                        <td class="py-3 px-4 text-gray-900">$UYU ${customer.totalSpent.toLocaleString()}</td>
                        <td class="py-3 px-4 text-gray-900">${customer.lastOrderAt ? new Date(customer.lastOrderAt).toLocaleDateString() : '-'}</td>
                    `;
                    tbody.appendChild(tr);
                });
                
            } catch (error) {
                console.error('Error loading customers:', error);
            }
        }

        function confirmDeleteProduct(productId) {
            if (confirm('¿Estás seguro de que quieres eliminar este producto?')) {
                deleteProduct(productId).then(() => {
                    loadProducts();
                }).catch(error => {
                    alert('Error al eliminar el producto');
                });
            }
        }

        // Form submission
        document.getElementById('product-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('product-name').value,
                description: document.getElementById('product-description').value,
                price: parseFloat(document.getElementById('product-price').value),
                stockQuantity: parseInt(document.getElementById('product-stock').value),
                category: document.getElementById('product-category').value,
                sizes: document.getElementById('product-sizes').value.split(',').map(s => s.trim()).filter(s => s),
                imageUrl: document.getElementById('product-image').value,
                featured: document.getElementById('product-featured').checked,
                inStock: true
            };
            
            const productId = document.getElementById('product-id').value;
            if (productId) {
                formData.id = parseInt(productId);
            }
            
            try {
                await saveProduct(formData);
                hideProductModal();
                loadProducts();
                if (document.getElementById('dashboard-section').classList.contains('hidden') === false) {
                    loadDashboard();
                }
            } catch (error) {
                alert('Error al guardar el producto');
            }
        });

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            showSection('dashboard');
        });
    </script>
</body>
</html>

